package aman.lyricify;

import okhttp3.*;
import org.json.JSONArray;
import org.json.JSONObject;
import java.io.IOException;
import java.net.URLEncoder;
import java.util.ArrayList;
import java.util.concurrent.TimeUnit;

public class ApiClient {

    private static final String BASE_URL = "https://lyrics.paxsenix.org/";

    // OkHttpClient with timeouts
    private static final OkHttpClient client =
            new OkHttpClient.Builder()
                    .connectTimeout(20, TimeUnit.SECONDS)
                    .readTimeout(60, TimeUnit.SECONDS)
                    .build();

    public interface SearchCallback {
        void onSuccess(ArrayList<Song> songs);
        void onFailure(String error);
    }

    public interface LyricsCallback {
        void onSuccess(String lyrics);
        void onFailure(String error);
    }

    // ------------------------------------------------------------
    // SEARCH SONGS (dual URL, first valid result wins)
    // ------------------------------------------------------------
    public static void searchSongs(String query, SearchCallback callback) {
        try {
            String encodedQuery = URLEncoder.encode(query, "UTF-8");

            String url1 = BASE_URL + "searchAppleMusic.php?q=" + encodedQuery;
            String url2 = "https://paxsenix.alwaysdata.net/searchAppleMusic.php?q=" + encodedQuery;

            Request req1 = new Request.Builder().url(url1).build();
            Request req2 = new Request.Builder().url(url2).build();

            final boolean[] callbackCalled = {false};

            Callback commonCallback =
                    new Callback() {
                        @Override
                        public void onFailure(Call call, IOException e) {
                            synchronized (callbackCalled) {
                                if (!callbackCalled[0]) {
                                    callbackCalled[0] = true;
                                    callback.onFailure("Network error: " + e.getMessage());
                                }
                            }
                        }

                        @Override
                        public void onResponse(Call call, Response response) throws IOException {
                            if (!response.isSuccessful()) {
                                synchronized (callbackCalled) {
                                    if (!callbackCalled[0]) {
                                        callbackCalled[0] = true;
                                        callback.onFailure("Server error: " + response.code());
                                    }
                                }
                                return;
                            }

                            String json = response.body().string();

                            try {
                                JSONArray array = new JSONArray(json);
                                ArrayList<Song> songs = new ArrayList<>();

                                for (int i = 0; i < array.length(); i++) {
                                    JSONObject obj = array.getJSONObject(i);
                                    songs.add(
                                            new Song(
                                                    obj.getString("id"),
                                                    obj.getString("songName"),
                                                    obj.getString("artistName"),
                                                    obj.getString("albumName"),
                                                    obj.getString("artwork"),
                                                    obj.getString("releaseDate"),
                                                    obj.getString("duration"),
                                                    obj.getString("contentRating")));
                                }

                                synchronized (callbackCalled) {
                                    if (!callbackCalled[0]) {
                                        callbackCalled[0] = true;
                                        callback.onSuccess(songs);
                                    }
                                }

                            } catch (Exception e) {
                                synchronized (callbackCalled) {
                                    if (!callbackCalled[0]) {
                                        callbackCalled[0] = true;
                                        callback.onFailure("Failed to parse data: " + e.getMessage());
                                    }
                                }
                            }
                        }
                    };

            client.newCall(req1).enqueue(commonCallback);
            client.newCall(req2).enqueue(commonCallback);

        } catch (Exception e) {
            callback.onFailure("Encoding error: " + e.getMessage());
        }
    }

    // ------------------------------------------------------------
    // GET LYRICS (single URL as you had)
    // ------------------------------------------------------------
    public static void getLyrics(String songId, LyricsCallback callback) {
        String url = BASE_URL + "getAppleMusicLyrics.php?id=" + songId;
        Request request = new Request.Builder().url(url).build();

        client.newCall(request)
                .enqueue(
                        new Callback() {
                            @Override
                            public void onFailure(Call call, IOException e) {
                                String errMsg =
                                        "Network error: "
                                                + e.getClass().getSimpleName()
                                                + " - "
                                                + e.getMessage();
                                callback.onFailure(errMsg);

                                if (e instanceof java.net.SocketTimeoutException) {
                                    client.newCall(request).enqueue(this);
                                } else {
                                    callback.onFailure("Network error: " + e.getMessage());
                                }
                            }

                            @Override
                            public void onResponse(Call call, Response response)
                                    throws IOException {
                                if (response.isSuccessful()) {
                                    String responseText = response.body().string();

                                    if (responseText.isEmpty()) {
                                        callback.onSuccess("No lyrics found");
                                        return;
                                    }

                                    try {
                                        JSONObject json = new JSONObject(responseText);
                                        if (json.has("content")) {
                                            String lrcLyrics =
                                                    LyricsParser.convertToLRC(responseText);
                                            callback.onSuccess(lrcLyrics);
                                        } else {
                                            callback.onSuccess(responseText);
                                        }
                                    } catch (Exception e) {
                                        callback.onSuccess(responseText);
                                    }
                                } else {
                                    callback.onFailure(
                                            "No lyrics found (HTTP " + response.code() + ")");
                                }
                            }
                        });
    }

    // ------------------------------------------------------------
    // GET LYRICS BY TITLE + ARTIST
    // ------------------------------------------------------------
    public static void getLyricsByTitleAndArtist(
            String title, String artist, LyricsCallback callback) {
        searchSongs(
                title + " " + artist,
                new SearchCallback() {
                    @Override
                    public void onSuccess(ArrayList<Song> songs) {
                        if (songs.isEmpty()) {
                            callback.onFailure("Song not found");
                            return;
                        }
                        getLyrics(songs.get(0).getId(), callback);
                    }

                    @Override
                    public void onFailure(String error) {
                        callback.onFailure(error);
                    }
                });
    }
}